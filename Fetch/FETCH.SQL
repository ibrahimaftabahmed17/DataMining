--What are the top 5 brands by receipts scanned for most recent month?
WITH CTE AS (
SELECT RRI.RECEIPTID ,RRI.BRANDCODE , COUNT(*) AS COUNT_BRAND
FROM REWARDRECEIPTITEM RRI
INNER JOIN RECEIPT R
ON R.RECEIPTID = RRI.RECEIPTID
WHERE DATEPART(m, R.DATESCANNED) = DATEPART(m, DATEADD(m, -1, GETDATE()))
AND DATEPART(y, R.DATESCANNED) = DATEPART(y, DATEADD(m, -1, GETDATE()))
GROUP BY RRI.RECEIPTID ,RRI.BRANDCODE)

SELECT  TOP(5) B.NAME, B.BRANDCODE, COUNT(CTE.RECEIPTID) AS TOTAL_RECEIPTS, ROW_NUMBER() OVER(ORDER BY COUNT(CTE.RECEIPTID) DESC) AS RECENT_RANK
INTO #TEMP 
FROM CTE INNER JOIN BRAND B
ON CTE.BRANDCODE = B.BRANDCODE
WHERE CTE.COUNT_BRAND >=1
GROUP BY B.NAME,B.BRANDCODE
ORDER BY COUNT(CTE.RECEIPTID) ;

--How does the ranking of the top 5 brands by receipts scanned for the recent month compare to the ranking for the previous month?
WITH CTE2 AS (
SELECT RRI.RECEIPTID ,RRI.BRANDCODE , COUNT(*) AS COUNT_BRAND
FROM REWARDRECEIPTITEM RRI
INNER JOIN RECEIPT R
ON R.RECEIPTID = RRI.RECEIPTID
WHERE DATEPART(m, R.DATESCANNED) = DATEPART(m, DATEADD(m, -2, GETDATE()))
AND DATEPART(y, R.DATESCANNED) = DATEPART(y, DATEADD(m, -2, GETDATE()))
GROUP BY RRI.RECEIPTID ,RRI.BRANDCODE)

SELECT B.NAME, B.BRANDCODE, DENSE_RANK() OVER(PARTITION BY B.NAME, B.BRANDCODE ORDER BY COUNT(CTE2.RECEIPTID) DESC ) AS PREVIOUS_RANK , #TEMP.RECENT_RANK
FROM CTE2 INNER JOIN BRAND B
ON CTE2.BRANDCODE = B.BRANDCODE
INNER JOIN #TEMP ON #TEMP.BRANDCODE = B.BRANDCODE
WHERE CTE2.COUNT_BRAND >=1
GROUP BY B.NAME,B.BRANDCODE

--When considering average spend from receipts with 'rewardsReceiptStatus’ of ‘Accepted’ or ‘Rejected’, which is greater?

SELECT TOP(1) REWARDSRECEIPTSTATUS,AVG(TOTALSPENT) AS AVG_SPENT
FROM RECEIPT
WHERE REWARDSRECEIPTSTATUS IN ('REJECTED','FINISHED')
GROUP BY REWARDSRECEIPTSTATUS
ORDER BY AVG_SPENT DESC 

--When considering total number of items purchased from receipts with 'rewardsReceiptStatus’ of ‘Accepted’ or ‘Rejected’, which is greater?
SELECT TOP(1) REWARDSRECEIPTSTATUS,SUM(PURCHASEDITEMCOUNT) AS AVG_SPENT
FROM RECEIPT
WHERE REWARDSRECEIPTSTATUS IN ('REJECTED','FINISHED')
GROUP BY REWARDSRECEIPTSTATUS
ORDER BY AVG_SPENT DESC 


--Which brand has the most spend among users who were created within the past 6 months?

WITH CTE AS(
SELECT R.RECEIPTID FROM
RECEIPT R 
WHERE R.USERID IN (
SELECT oid
FROM USER
WHERE CREATEDDATE >= DATEADD(m, -6, GETDATE()))
)

WITH CTE2 AS(
SELECT RRI.RECEIPTID , RRI.BRANDCODE , SUM(RRI.FINALPRICE) AS BRAND_SPEND_BY_RECEIPT
FROM REWARDRECEIPTITEM RRI
GROUP BY RRI.RECEIPTID , RRI.BRANDCODE)

SELECT TOP(1) CTE2.BRANDCODE
FROM
CTE INNER JOIN CTE2
ON CTE.RECEIPTID = CTE2.RECEIPTID
GROUP BY CTE2.BRANDCODE
ORDER BY SUM(CTE2.BRAND_SPEND_BY_RECEIPT) 




--Which brand has the most transactions among users who were created within the past 6 months?


WITH CTE AS(
SELECT R.RECEIPTID FROM
RECEIPT R 
WHERE R.USERID IN (
SELECT oid
FROM USER
WHERE CREATEDDATE >= DATEADD(m, -6, GETDATE()))
)

WITH CTE2 AS(
SELECT RRI.RECEIPTID , RRI.BRANDCODE , COUNT(DISTINCT RRI.RECEIPTID) AS TOTAL_UNIQUE_TXNS
FROM REWARDRECEIPTITEM RRI
GROUP BY RRI.RECEIPTID , RRI.BRANDCODE)


SELECT TOP(1) CTE2.BRANDCODE
FROM
CTE INNER JOIN CTE2
ON CTE.RECEIPTID = CTE2.RECEIPTID
GROUP BY CTE2.BRANDCODE
ORDER BY SUM(CTE2.TOTAL_UNIQUE_TXNS) 






